<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://finger-bone.github.io/micro-service-crashcourse/11/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Seata 分布式事务 - 微服务速成笔记</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/color-brewer.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">微服务速成笔记</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Spring Cloud 微服务技术 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../01/" class="dropdown-item">回到 Spring</a>
</li>
                                    
<li>
    <a href="../02/" class="dropdown-item">回到 Java</a>
</li>
                                    
<li>
    <a href="../03/" class="dropdown-item">Consul 作为服务注册中心</a>
</li>
                                    
<li>
    <a href="../04/" class="dropdown-item">Consul 作为配置中心</a>
</li>
                                    
<li>
    <a href="../05/" class="dropdown-item">LoadBalancer</a>
</li>
                                    
<li>
    <a href="../06/" class="dropdown-item">Http Interface Client 与 OpenFeign</a>
</li>
                                    
<li>
    <a href="../07/" class="dropdown-item">Resilience4j 服务熔断和降级</a>
</li>
                                    
<li>
    <a href="../08/" class="dropdown-item">Resilience4j 限流</a>
</li>
                                    
<li>
    <a href="../09/" class="dropdown-item">Micrometer 监控</a>
</li>
                                    
<li>
    <a href="../10/" class="dropdown-item">Spring Gateway 网关</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Seata 分布式事务</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Spring 进阶内容 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../12/" class="dropdown-item">Reactor 框架</a>
</li>
                                    
<li>
    <a href="../13/" class="dropdown-item">Spring WebFlux</a>
</li>
                                    
<li>
    <a href="../14/" class="dropdown-item">Spring Security</a>
</li>
                                    
<li>
    <a href="../15/" class="dropdown-item">Spring Security OAuth2 认证以及 KeyCloak 用户服务</a>
</li>
                                    
<li>
    <a href="../16/" class="dropdown-item">Rabbit MQ 消息队列</a>
</li>
                                    
<li>
    <a href="../17/" class="dropdown-item">GraphQL</a>
</li>
                                    
<li>
    <a href="../18/" class="dropdown-item">gRPC</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">k8s 微服务技术 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../19/" class="dropdown-item">后端框架一览</a>
</li>
                                    
<li>
    <a href="../20/" class="dropdown-item">k8s 无状态服务基本部署</a>
</li>
                                    
<li>
    <a href="../21/" class="dropdown-item">helm 打包 istio 网关与 k8s 命令行工具</a>
</li>
                                    
<li>
    <a href="../22/" class="dropdown-item">k8s 无状态服务</a>
</li>
                                    
<li>
    <a href="../23/" class="dropdown-item">k8s 有状态服务</a>
</li>
                                    
<li>
    <a href="../24/" class="dropdown-item">服务网格</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">中间件补充 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../25/" class="dropdown-item">Nacos 服务治理</a>
</li>
                                    
<li>
    <a href="../26/" class="dropdown-item">Sentinel</a>
</li>
                                    
<li>
    <a href="../27/" class="dropdown-item">kafka 高性能消息队列</a>
</li>
                                    
<li>
    <a href="../28/" class="dropdown-item">Redis</a>
</li>
                                    
<li>
    <a href="../29/" class="dropdown-item">OTel-LGTM</a>
</li>
                                    
<li>
    <a href="../30/" class="dropdown-item">Dubbo RPC</a>
</li>
                                    
<li>
    <a href="../31.md" class="dropdown-item">Nginx</a>
</li>
                                    
<li>
    <a href="../32.md" class="dropdown-item">Treafik</a>
</li>
                                    
<li>
    <a href="../33.md" class="dropdown-item">Citus</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../10/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../12/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#spring-cloud-ch11-seata" class="nav-link">Spring Cloud 速成 Ch11 分布式事务 Seata</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#_1" class="nav-link">事务</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_2" class="nav-link">分布式事务</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#seata" class="nav-link">Seata 的基本原理</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#seata_1" class="nav-link">Seata 的配置</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#seata_2" class="nav-link">Seata 的使用</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="spring-cloud-ch11-seata">Spring Cloud 速成 Ch11 分布式事务 Seata</h1>
<p>Seata 属于 Spring Cloud Alibaba 的组件，这里我们介绍它的原因是 Spring Cloud 官方并没有提供分布式事务的解决方案，而 Seata 是一个开源的分布式事务解决方案，它提供了 AT、TCC、SAGA、XA 四种分布式事务解决方案，其中 AT 模式是最常用的。我们只介绍 AT 模式。</p>
<h2 id="_1">事务</h2>
<p>Spring 中，事务是指的是一组操作，要么全部成功，要么全部失败。在 Spring 中使用事务，我们可以使用 <code>@Transactional</code> 注解，它可以用在类上，也可以用在方法上，用在类上表示类中的所有方法都是事务性的，用在方法上表示该方法是事务性的。</p>
<pre><code class="language-java">@Service
public class UserService {

    @Autowired
    private UserDao userDao;

    @Transactional
    public void add() {
        userDao.add();
        int i = 1 / 0;
    }
}
</code></pre>
<p>加上这个注解后，Spring 会在方法执行前开启一个事务，方法执行后，如果没有异常，会提交事务，如果有异常，会回滚事务。这里的回滚是通过 AOP 实现的，Spring 会在方法执行前后插入一些代码，这些代码就是事务的实现。</p>
<h2 id="_2">分布式事务</h2>
<p>在分布式系统中，事务的问题会更加复杂，因为事务不再是在一个数据库中，而是在多个数据库中。在分布式系统中，我们需要保证事务的 ACID 特性，</p>
<ul>
<li>原子性（Atomicity）：事务是一个不可分割的工作单位，要么全部成功，要么全部失败。但是在分布式系统中，事务可能会在多个数据库中，这就需要保证所有数据库的事务要么全部成功，要么全部失败。</li>
<li>一致性（Consistency）：事务执行前后，数据的完整性没有被破坏。但是在分布式系统中，数据可能会在多个数据库中，这就需要保证所有数据库的数据一致。</li>
<li>隔离性（Isolation）：事务之间是相互隔离的，一个事务的执行不会影响另一个事务的执行。但是在分布式系统中，事务可能会在多个数据库中，这就需要保证所有数据库的事务之间是隔离的。</li>
<li>持久性（Durability）：事务执行后，数据是持久化的。但是在分布式系统中，数据可能会在多个数据库中，这就需要保证所有数据库的数据是持久化的。</li>
</ul>
<p>Seata 便是一个解决分布式事务的解决方案。</p>
<h2 id="seata">Seata 的基本原理</h2>
<p>Seata 有三大核心概念：</p>
<ul>
<li>TC（Transaction Coordinator）：事务协调器，负责事务的协调和全局事务的管理。即 Seata 本身。</li>
<li>TM（Transaction Manager）：事务管理器，负责事务的开启、提交、回滚。即事务的发起者，它负责定义全局事务的范围，即要操作哪些数据库。一般是第一个被调的，带事务注解的方法。</li>
<li>RM （Resource Manager）：资源管理器，负责管理分支事务的注册、状态汇报、回滚。即数据库本身。</li>
</ul>
<p>每个 Seata 事务的生命周期如下：</p>
<ol>
<li>TM 开启一个全局事务，生成一个 XID（全局事务 ID）。</li>
<li>XID 传递给 RM，RM 生成一个 Branch ID（分支事务 ID）。</li>
<li>RM 开启一个分支事务，执行业务逻辑。</li>
<li>RM 将 Branch ID 和 XID 传递给数据库，数据库将 Branch ID 和 XID 保存到数据库中。</li>
<li>TM 收到 RM 的返回，如果所有 RM 都返回成功，TM 提交事务，如果有一个 RM 返回失败，TM 回滚事务。</li>
</ol>
<p>对于 AT 模式，具体而言，是通过锁和两次提交来实现的。</p>
<p>第一个阶段，业务数据和回滚日志在同一个本地事务中提交，在提交前后，会记录快照。第一阶段结束后，会生成行锁。第一个阶段是一个完整的本地事务。</p>
<p>第二个阶段，如果没有异常，只要删除第一阶段的锁、日志、快照即可。如果有异常，会通过第一阶段的日志和快照进行回滚。</p>
<h2 id="seata_1">Seata 的配置</h2>
<p>为了方便部署，这里依然使用 Docker。但注意，一般而言数据库不会放在 Docker 里。其它部署方式见<a href="https://seata.apache.org/docs/ops/deploy-guide-beginner">文档</a>。</p>
<h3 id="_3">启动服务</h3>
<p>首先，启动一个 Seata 服务：</p>
<pre><code class="language-yml">seata-server:
    image: seataio/seata-server:2.0.0
    ports:
      - &quot;7091:7091&quot;
      - &quot;8091:8091&quot;
    depends_on:
      - postgres
      - consul
    volumes:
      - ./seata/application.yml:/seata-server/resources/application.yml
</code></pre>
<h3 id="_4">修改配置</h3>
<p><code>./seata/application.yml</code>的具体内容要根据你的配置而定，模版可以在容器内的<code>/seata-server/resources/application.example.yml</code>找到，或者在<a href="https://github.com/apache/incubator-seata/blob/develop/server/src/main/resources/application.example.yml">GitHub</a>。</p>
<p>如果用 consul 和 postgres，配置如下：</p>
<pre><code class="language-yml">seata:
  config:
    # support: nacos 、 consul 、 apollo 、 zk  、 etcd3
    type: consul
    consul:
      server-addr: consul:8500
      acl-token:
      key: seata.properties
  registry:
    # support: nacos 、 eureka 、 redis 、 zk  、 consul 、 etcd3 、 sofa
    type: consul
    consul:
      cluster: seata-server
      server-addr: consul:8500
      acl-token:
</code></pre>
<p>其它的配置都是通过 Consul 完成的。</p>
<p>注意，这里 register 的 cluster 是 Consul 的服务名，之后我们要要在客户端的配置文件中使用这个服务名。</p>
<h3 id="server">Server 服务注册与配置</h3>
<p>如果使用服务中心方式，需要在服务中心进行配置。下文以 Consul 为例。</p>
<p>要把 Consul 作为 seata 注册地，启动 seata 前，将<a href="https://github.com/apache/incubator-seata/blob/1.4.2/script/config-center/config.txt">这个配置文件</a>提交给 consul，否则会报错。</p>
<p>这里可以使用官方提供的<a href="https://github.com/apache/incubator-seata/blob/1.4.2/script/config-center/consul/consul-config.sh">脚本</a>，进入容器内使用。注意，config.txt 文件要放在这个脚本的上级目录。这一步是将 Consul 作为注册中心需要的。</p>
<p>注意，因为我们用了 postgres，要修改这一部分配置。</p>
<pre><code class="language-properties">store.db.datasource=druid
store.db.dbType=postgresql
store.db.driverClassName=org.postgresql.Driver
store.db.url=jdbc:postgresql://postgres:5432/seata
store.db.user=user
store.db.password=password
</code></pre>
<p>这些参数的含义参考这个<a href="https://seata.apache.org/zh-cn/docs/user/configurations">文档</a>。</p>
<p>而将 Consul 作为配置中心，还要创建一个<code>seata.properties</code>文件，目前留空即可，因为前面的配置文件已经包含了所有配置。</p>
<h3 id="client">Client 事务分组与配置</h3>
<p>我们讲解在配置文件中唯一重要的概念，事务分组。事务分组是指将一个 Seata 集群中不同服务器分成若干组，然后一些微服务会使用某个分组。</p>
<p>首先，我们需要在两个服务中引入 Seata Client 的依赖。</p>
<pre><code class="language-groovy">implementation 'io.seata:seata-spring-boot-starter:2.0.0'
implementation 'io.seata:seata-all:2.0.0'
</code></pre>
<p>使用 Spring Boot 时，默认的配置文件如下，</p>
<pre><code class="language-yml">seata:
  registry:
    type: consul
    consul:
      server-addr: 127.0.0.1:8500
  # 事务分组配置，1.4.2 默认名称为 my_test_tx_group ，1.5版本将改为 default_tx_group
  tx-service-group: my_test_tx_group
  service:
    # 事务分组与集群映射关系
    vgroup-mapping:
      my_test_tx_group: default
</code></pre>
<p>全部的配置可以见<a href="https://github.com/apache/incubator-seata/blob/develop/script/client/spring/application.yml">这个文件</a>。</p>
<p>具体而言，对于一个微服务，它在寻找自己对应的 Seata 服务器时，会经过如下步骤（假设使用 boot 版本）：</p>
<ol>
<li>Client 会先在配置文件的<code>seata.tx-service-group</code>中找到事务分组的名字。这个值默认是 my_test_tx_group。</li>
<li>Client 会在<code>seata.service.vgroupMapping.${seata.tx-service-group}</code>中找到这个分组对应的服务名。这个值记为分组名<code>group-name</code>。如果使用远程配置，这个值的 key 省略为<code>service.vgroup-mapping.${seata.tx-service-group}</code>。</li>
<li>Client 在<code>service.grouplist.${group-name}</code>找到这个分组的服务器地址。使用远程配置时，会用<code>${group-name}</code>作为服务名去找。</li>
</ol>
<p>如果全用本地配置，应当这样（type 字段默认都是 file）：</p>
<pre><code class="language-yml">seata:
  registry:
    consul:
      server-addr: localhost:8500
  tx-service-group: tx_group
  service:
    vgroup-mapping:
      tx_group: seata-group
    grouplist:
      seata-group: 127.0.0.1:8091
</code></pre>
<p>对于我们使用 consul，应该这样配置：</p>
<pre><code class="language-yml">seata:
  config:
    type: consul
    consul:
      server-addr: localhost:8500
  registry:
    type: consul
    consul:
      server-addr: localhost:8500
  tx-service-group: tx_group
</code></pre>
<p>而 service 部分应当远程配置，即在 Consul 的 KV 中，我们之前的 config 只添加了默认的配置，现在要添加这些字段：</p>
<pre><code class="language-properties">service.vgroup-mapping.tx_group=seata-server
</code></pre>
<p>这里 seata-server 是我们的服务名，即之前配置的<code>cluster</code>。</p>
<p>但是，注意，目前因为我们使用了 docker 配置，所以我这里获取的 seata 地址是<code>172.18.0.5:8091</code>，这是容器内的地址。在生产环境中，如果产品也是运行在 docker 环境中，只要设置 exposed 就可以了。但是现在我们的产品是运行在本地的，而 seata 运行在 docker 内，要么让 docker 网络和本地网络相连，要么把一整套迁移到本地。</p>
<p>因此为了避免麻烦，下面的演示使用 file 模式配置。</p>
<h3 id="_5">数据库配置</h3>
<p>然后，Seata 需要一个单独的数据库，用于保存事务信息。这个文件可以从 Seata 官方<a href="https://github.com/apache/incubator-seata/tree/develop/script/server/db">下载</a>，然后自行建立一个新的名为<code>seata</code>的数据库，导入这个文件。</p>
<p>创建之后，应该有这样的表：</p>
<p><img alt="创建 seata 表" src="image.png" /></p>
<p>之后，重新启动 Seata 服务，会有一些错误，但是最后会成功启动。Seata 需要一点时间从 Consul 读取信息。最后，命令行上会输出 web 界面的地址，访问这个地址，可以看到 Seata 的控制台。Consul 中也会有 Seata 服务的注册。</p>
<p>输入 application.yml 里的账号和密码后，可以看到这个界面：</p>
<p><img alt="Seata 控制台" src="image-1.png" /></p>
<h2 id="seata_2">Seata 的使用</h2>
<p>为了测试，我们人为构造一个没有意义的事务。现在创建两个数据表，每个数据表都有一个 id，第一个数据表有一个 name，第二个数据表有一个 age。我们要保证这两个表的数据要么同时插入，要么同时删除。</p>
<pre><code class="language-sql">CREATE TABLE name (
    id SERIAL PRIMARY KEY,
    name TEXT
);
CREATE TABLE age (
    id SERIAL PRIMARY KEY,
    age INT
);
</code></pre>
<p>然后创建对应的 Repository 和 Record。因为我们要测试的场景是分布式事务，即若干微服务都操作数据库。</p>
<p>我们在之前的，作为 provider 的 payment 服务中，提供一个新的 API，这个 API 应当向 name 表插入数据。</p>
<pre><code class="language-java">package io.github.fingerbone.entity;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import lombok.AllArgsConstructor;
import lombok.Data;

@Entity
@Data
@AllArgsConstructor
public class Name {
    @Column
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column
    private String name;
}

package io.github.fingerbone.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import io.github.fingerbone.entity.Name;

@Repository
public interface NameRepository extends JpaRepository&lt;Name, Long&gt; {

}

package io.github.fingerbone.service;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import io.github.fingerbone.entity.Name;
import io.github.fingerbone.repository.NameRepository;
import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class NameService {
    private final NameRepository nameRepository;

    public void createName(String name) {
        System.out.println(&quot;Will create name with name: &quot; + name);
        nameRepository.save(
            new Name(null, name)
        );
    }
}

package io.github.fingerbone.controller;

import io.github.fingerbone.entity.Payment;
import io.github.fingerbone.record.PaymentRecord;
import io.github.fingerbone.service.NameService;
import io.github.fingerbone.service.PaymentService;
import io.github.fingerbone.wrapper.ResponseWrapper;
import lombok.RequiredArgsConstructor;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.PutMapping;

import java.util.stream.Collectors;
import java.util.List;

@RestController
@RequestMapping(&quot;/payment&quot;)
@RequiredArgsConstructor
public class PaymentController {
    private final NameService nameService;

    @PostMapping(&quot;/name&quot;)
    public void createName(@RequestParam String name) {
        nameService.createName(name);
    }
}
</code></pre>
<p>然后是 order 服务，这个服务应当向 age 表插入数据，然后请求 payment 服务插入 name 表数据。</p>
<pre><code class="language-java">@HttpExchange(&quot;http://payment-service/payment&quot;)
public interface PaymentAPIIf {

    @PostExchange(&quot;/name&quot;)
    void createName(@RequestParam String name);
}

package io.github.fingerbone;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import lombok.AllArgsConstructor;
import lombok.Data;

@Entity
@Data
@AllArgsConstructor
public class Age {
    @Id
    @Column
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column
    private Short age;
}

package io.github.fingerbone;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface AgeRepository extends JpaRepository&lt;Age, Long&gt; {


}

package io.github.fingerbone;

import org.springframework.stereotype.Service;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class AgeService {
    private final AgeRepository ageRepository;
    private final PaymentAPIIf paymentAPIIf;

    public void create(String name, Short age) {
        System.out.println(&quot;Will create age with name: &quot; + name + &quot; and age: &quot; + age);
        ageRepository.save(
            new Age(null, age)
        );
        System.out.println(&quot;Will create name with name: &quot; + name);
        paymentAPIIf.createName(name);
    }
}

package io.github.fingerbone;


import io.github.fingerbone.api.PaymentApi;
import io.github.fingerbone.record.PaymentRecord;
import io.github.fingerbone.wrapper.ResponseCode;
import io.github.fingerbone.wrapper.ResponseWrapper;
import io.github.resilience4j.bulkhead.annotation.Bulkhead;
import io.github.resilience4j.circuitbreaker.annotation.CircuitBreaker;
import lombok.Data;
import lombok.RequiredArgsConstructor;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpEntity;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.client.RestTemplate;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.HttpMethod;

import java.util.List;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;


@RestController
@RequestMapping(&quot;/if/payment&quot;)
@RequiredArgsConstructor
public class ConsumerPaymentController {
    private final AgeService ageService;
    @PostMapping(&quot;/age&quot;)
    public void createAge(@RequestParam String name, @RequestParam Short age) {
        ageService.create(name, age);
    }
}
</code></pre>
<p>现在，启动两个服务，进行测试，可以发现 name 表与 age 表可以被正确操作了。</p>
<p>现在，我们希望插入 name 和 age 作为同一个事务，即要么同时插入，要么同时删除。两个微服务的两个 Service 作为同一个事务进行处理。</p>
<p>参考 Seata 的<a href="https://seata.apache.org/docs/user/quickstart#step-2-create-undo_log-table">文档</a>，在 AT 模式下，需要在需要事务操作的数据库中创建一个<code>undo_log</code>表。脚本在<a href="https://github.com/apache/incubator-seata/blob/2.x/script/client/at/db">这里</a>。</p>
<p>要使用 Seata，只需要为 TM 方法加上<code>@GlobalTransactional</code>注解即可，即整个微服务调用链的发起方法。</p>
<pre><code class="language-java">@GlobalTransactional(name = &quot;createUser&quot;, timeoutMills = 10000, rollbackFor = Exception.class)
</code></pre>
<p>现在，如果在被调微服务中手动触发异常，可以发现，尽管命令行中输出了插入的相关信息，但数据库里并没有信息，说明触发了 Rollback，命令行上也有相关的输出。</p>
<p>在 Seata 的控制台上，也有相关记录。</p>
<p><img alt="Seata 有记录的控制台" src="image-2.png" /></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
