<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://finger-bone.github.io/micro-service-crashcourse/17/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>GraphQL - 微服务速成笔记</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/color-brewer.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">微服务速成笔记</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Spring Cloud 微服务技术 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../01/" class="dropdown-item">回到 Spring</a>
</li>
                                    
<li>
    <a href="../02/" class="dropdown-item">回到 Java</a>
</li>
                                    
<li>
    <a href="../03/" class="dropdown-item">Consul 作为服务注册中心</a>
</li>
                                    
<li>
    <a href="../04/" class="dropdown-item">Consul 作为配置中心</a>
</li>
                                    
<li>
    <a href="../05/" class="dropdown-item">LoadBalancer</a>
</li>
                                    
<li>
    <a href="../06/" class="dropdown-item">Http Interface Client 与 OpenFeign</a>
</li>
                                    
<li>
    <a href="../07/" class="dropdown-item">Resilience4j 服务熔断和降级</a>
</li>
                                    
<li>
    <a href="../08/" class="dropdown-item">Resilience4j 限流</a>
</li>
                                    
<li>
    <a href="../09/" class="dropdown-item">Micrometer 监控</a>
</li>
                                    
<li>
    <a href="../10/" class="dropdown-item">Spring Gateway 网关</a>
</li>
                                    
<li>
    <a href="../11/" class="dropdown-item">Seata 分布式事务</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Spring 进阶内容 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../12/" class="dropdown-item">Reactor 框架</a>
</li>
                                    
<li>
    <a href="../13/" class="dropdown-item">Spring WebFlux</a>
</li>
                                    
<li>
    <a href="../14/" class="dropdown-item">Spring Security</a>
</li>
                                    
<li>
    <a href="../15/" class="dropdown-item">Spring Security OAuth2 认证以及 KeyCloak 用户服务</a>
</li>
                                    
<li>
    <a href="../16/" class="dropdown-item">Rabbit MQ 消息队列</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">GraphQL</a>
</li>
                                    
<li>
    <a href="../18/" class="dropdown-item">gRPC</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">k8s 微服务技术 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../19/" class="dropdown-item">后端框架一览</a>
</li>
                                    
<li>
    <a href="../20/" class="dropdown-item">k8s 无状态服务基本部署</a>
</li>
                                    
<li>
    <a href="../21/" class="dropdown-item">helm 打包 istio 网关与 k8s 命令行工具</a>
</li>
                                    
<li>
    <a href="../22/" class="dropdown-item">k8s 无状态服务</a>
</li>
                                    
<li>
    <a href="../23/" class="dropdown-item">k8s 有状态服务</a>
</li>
                                    
<li>
    <a href="../24/" class="dropdown-item">服务网格</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">中间件补充 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../25/" class="dropdown-item">Nacos 服务治理</a>
</li>
                                    
<li>
    <a href="../26/" class="dropdown-item">Sentinel</a>
</li>
                                    
<li>
    <a href="../27/" class="dropdown-item">kafka 高性能消息队列</a>
</li>
                                    
<li>
    <a href="../28/" class="dropdown-item">Redis</a>
</li>
                                    
<li>
    <a href="../29/" class="dropdown-item">OTel-LGTM</a>
</li>
                                    
<li>
    <a href="../30/" class="dropdown-item">Dubbo RPC</a>
</li>
                                    
<li>
    <a href="../31.md" class="dropdown-item">Nginx</a>
</li>
                                    
<li>
    <a href="../32.md" class="dropdown-item">Treafik</a>
</li>
                                    
<li>
    <a href="../33.md" class="dropdown-item">Citus</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../16/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../18/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#ch17-graphql" class="nav-link">微服务速成 Ch17 GraphQL</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#graphql" class="nav-link">GraphQL 基本概念</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#graphql_1" class="nav-link">GraphQL 语法</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#graphql_2" class="nav-link">GraphQL 后端搭建</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="ch17-graphql">微服务速成 Ch17 GraphQL</h1>
<p>前面我们所有的程序都是基于 RESTful API 构建的，但是 RESTful API 最大的问题是，所有的 API 本质都是一个黑盒，在你拿到数据之前，你不知道这个 API 会返回什么数据，这导致了前后端工作的耦合。GraphQL 就是为了解决这个问题而生的。</p>
<p>GraphQL 是一个查询语言，它允许客户端查询自己需要的数据，而不是服务端返回固定的数据。这样，前后端只要约定好数据库的结构，就可以独立开发，不需要等待对方的接口。</p>
<h2 id="graphql">GraphQL 基本概念</h2>
<p>GraphQL 是替换 RESTful API 的一种方式。因此前端和后端的交互方式和 RESTful API 有很大的不同。</p>
<p>在前端，与 RESTful API 不同，GraphQL 有且只有一个入口，即<code>/graphql</code>。所有的请求都通过这个入口，而不是通过不同的 URL。</p>
<p>通过 POST 方法，前端在 body 里发送一个 GraphQL 查询语句，后端解析这个查询语句，返回查询结果。</p>
<p>GraphQL 查询语句是一种专门的语言，类似于 SQL 对数据库的查询。它有自己的语法，可以查询多个字段，多个对象，多个关联对象。我们会在后面的章节详细介绍。</p>
<p>在后端，GraphQL 语句的解析和数据的获取由框架自动完成，我们只需要完成数据提供的任务即可。</p>
<h2 id="graphql_1">GraphQL 语法</h2>
<p>GraphQL 语法是一种类似于 JSON 的语言，但是比 JSON 更强大。它可以查询多个对象，多个字段，多个关联对象。</p>
<h3 id="_1">类型</h3>
<p>GraphQL 有一套独立于编程语言的类型系统。这个类型系统定义了所有的对象和字段的类型。</p>
<p>在 GraphQL 中，基本类型有，</p>
<ul>
<li>Int：整数</li>
<li>Float：浮点数</li>
<li>String：UTF-8 字符串</li>
<li>Boolean：true 或 false</li>
<li>ID：唯一标识符，通常是字符串。</li>
</ul>
<p>此外，还有一些装饰符，来从基础类型派生新的类型，</p>
<ul>
<li><code>[type]</code>：数组</li>
<li><code>type!</code>：非空，注意，默认情况下所有的类型都是可空的。</li>
</ul>
<p>如果要定义一个对象，可以使用<code>type</code>关键字，</p>
<pre><code class="language-graphql">type Country {
    name: String
}
</code></pre>
<p>之后可以同基本类型一样使用这个对象。</p>
<h3 id="schema">Schema</h3>
<p>Schema 定义了 GraphQL 允许的查询和变更。Schema 由 Query 和 Mutation 两部分组成。</p>
<h4 id="query">Query</h4>
<p>Query 是一个特殊的 type，定义名称为<code>Query</code>的对象，即可定义所有允许的查询。</p>
<p>例如，</p>
<pre><code class="language-graphql">type Country {
    name: String
}

type Query {
    countries: [Country]
}
</code></pre>
<p>如果要进行查询，可以使用<code>query</code>关键字，加上字段结构，</p>
<pre><code class="language-graphql">query {
    countries {
        name
    }
}
</code></pre>
<p>这个的含义即是，从<code>Query</code>对象中查询<code>countries</code>字段，然后查询每个的<code>name</code>字段。注意，所有的字段都要归结到基本类型。</p>
<p>注意，这里如果在类型定义中返回列表，那么查询时也需要返回列表，后面的查询对象，即要求只返回<code>name</code>，是作用在列表的每个对象上的。如果返回一个对象，后面的查询对象就是作用在这个对象上的。</p>
<p>这样定义的查询是无参的，如果要传参，可以在<code>countries</code>后面加上参数，</p>
<pre><code class="language-graphql">type Query {
    countries($code: String): Country
}
</code></pre>
<p>如果要传入参数，可以使用，</p>
<pre><code class="language-graphql">query {
    country(code: &quot;CN&quot;) {
        name
    }
}
</code></pre>
<p>如果要输入对象，需要使用<code>input</code>关键字，而不能使用之前的<code>type</code>。</p>
<pre><code class="language-graphql">input CountryInput {
    name: String
}

type Query {
    countries($input: CountryInput): [Country]
}
</code></pre>
<p>这样，如果要传入参数，可以使用，</p>
<pre><code class="language-graphql">query {
    countries(input: {name: &quot;China&quot;}) {
        name
    }
}
</code></pre>
<p>注意。所有的查询字段最后必须归结到基本类型。例如，</p>
<pre><code class="language-graphql">type Author {
    name: String
    books: [Book]
}

type Book{
    title: String
}

type Query {
    authors: [Author]
}
</code></pre>
<p>如果要查询所有的书名，应当是，</p>
<pre><code class="language-graphql">query {
    authors {
        books {
            title
        }
    }
}
</code></pre>
<h3 id="mutation">Mutation</h3>
<p>Mutation 也是一个特殊的 type，定义名称为<code>Mutation</code>的对象，即可定义所有允许的变更。</p>
<p>例如，</p>
<pre><code class="language-graphql">type Mutation {
    addCountry(name: String): Country
}
</code></pre>
<p>如果要进行变更，可以使用<code>mutation</code>关键字，</p>
<pre><code class="language-graphql">mutation {
    addCountry(name: &quot;China&quot;) {
        name
    }
}
</code></pre>
<p>其它的和 Query 类似。</p>
<h2 id="graphql_2">GraphQL 后端搭建</h2>
<p>现在我们开始搭建后端。首先，我们需要引入 GraphQL 的依赖，</p>
<pre><code class="language-groovy">dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-graphql'
    implementation 'org.springframework.boot:spring-boot-starter-webflux'
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
}
</code></pre>
<p>这里使用 Web 或者 WebFlux 都可以。</p>
<p>然后在<code>resources/graphql</code>目录下创建<code>schema.gqls</code>文件，定义 GraphQL 的 Schema，这个路径可以用<code>spring.graphql.schema.locations</code>配置，后缀名可以是<code>.gqls</code>或<code>.graphqls</code>。</p>
<pre><code class="language-gql">type Book {
    id: ID!
    title: String!
}

type Author {
    id: ID!
    name: String!
    books: [Book!]!
}

type Query {
    authors: [Author!]!
    author(id: ID!): Author!
    books: [Book!]!
    book(id: ID!): Book!
}

type Mutation {
    createAuthor(name: String!): Author!
    createBook(title: String!): Book!
    addBookToAuthor(authorId: ID!, bookId: ID!): Author!
}
</code></pre>
<p>然后创建<code>Author</code>和<code>Book</code>类，</p>
<pre><code class="language-java">@Data
public class Author {
    private String id;
    private String name;
    private List&lt;Book&gt; books;
}

@Data
public class Book {
    private String id;
    private String title;
}
</code></pre>
<p>然后，我们创建一下 Service 类，这里我们使用 Map 当作数据库。</p>
<pre><code class="language-java">@Service
public class AuthorBookService {
    private final Map&lt;String, Author&gt; authors = new HashMap&lt;&gt;();
    private final Map&lt;String, Book&gt; books = new HashMap&lt;&gt;();

    public Author createAuthor(String name) {
        Author author = new Author();
        author.setId(UUID.randomUUID().toString());
        author.setName(name);
        authors.put(author.getId(), author);
        return author;
    }

    public Book createBook(String title) {
        Book book = new Book();
        book.setId(UUID.randomUUID().toString());
        book.setTitle(title);
        books.put(book.getId(), book);
        return book;
    }

    public Author addBookToAuthor(String authorId, String bookId) {
        Author author = authors.get(authorId);
        Book book = books.get(bookId);
        author.getBooks().add(book);
        return author;
    }

    public List&lt;Author&gt; getAuthors() {
        return new ArrayList&lt;&gt;(authors.values());
    }

    public Author getAuthor(String id) {
        return authors.get(id);
    }

    public List&lt;Book&gt; getBooks() {
        return new ArrayList&lt;&gt;(books.values());
    }

    public Book getBook(String id) {
        return books.get(id);
    }
}
</code></pre>
<p>最后，为每一个 Query 和 Mutation 创建一个 Resolver，即 Controller。注意，不是<code>@RestController</code>，而是<code>@Controller</code>。</p>
<pre><code class="language-java">package io.github.fingerbone.demo;

import org.springframework.graphql.data.method.annotation.Argument;
import org.springframework.graphql.data.method.annotation.MutationMapping;
import org.springframework.graphql.data.method.annotation.QueryMapping;
import org.springframework.stereotype.Controller;

import java.util.List;

@Controller
public class AuthorBookController {
    private final AuthorBookService service;

    public AuthorBookController(AuthorBookService service) {
        this.service = service;
    }

    @QueryMapping
    public List&lt;Author&gt; authors() {
        return service.getAuthors();
    }

    @QueryMapping
    public Author author(@Argument String id) {
        return service.getAuthor(id);
    }

    @QueryMapping
    public List&lt;Book&gt; books() {
        return service.getBooks();
    }

    @QueryMapping
    public Book book(@Argument String id) {
        return service.getBook(id);
    }

    @MutationMapping
    public Author createAuthor(@Argument String name) {
        return service.createAuthor(name);
    }

    @MutationMapping
    public Book createBook(@Argument String title) {
        return service.createBook(title);
    }

    @MutationMapping
    public Author addBookToAuthor(@Argument String authorId, @Argument String bookId) {
        return service.addBookToAuthor(authorId, bookId);
    }
}
</code></pre>
<p>然后可以打开 graphiql，这是一个 GraphQL 的接口测试工具，可以在这里测试 GraphQL 的查询和变更。</p>
<pre><code class="language-yaml">spring.graphql.graphiql.enabled: true
</code></pre>
<p>然后访问<code>/graphiql</code>即可。现在我们就可以在这里测试 GraphQL 的查询和变更了。当然，Postman 也支持 GraphQL。</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
