<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="https://finger-bone.github.io/micro-service-crashcourse/26/">
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Sentinel - 微服务速成笔记</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/color-brewer.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">微服务速成笔记</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Spring Cloud 微服务技术 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../01/" class="dropdown-item">回到 Spring</a>
</li>
                                    
<li>
    <a href="../02/" class="dropdown-item">回到 Java</a>
</li>
                                    
<li>
    <a href="../03/" class="dropdown-item">Consul 作为服务注册中心</a>
</li>
                                    
<li>
    <a href="../04/" class="dropdown-item">Consul 作为配置中心</a>
</li>
                                    
<li>
    <a href="../05/" class="dropdown-item">LoadBalancer</a>
</li>
                                    
<li>
    <a href="../06/" class="dropdown-item">Http Interface Client 与 OpenFeign</a>
</li>
                                    
<li>
    <a href="../07/" class="dropdown-item">Resilience4j 服务熔断和降级</a>
</li>
                                    
<li>
    <a href="../08/" class="dropdown-item">Resilience4j 限流</a>
</li>
                                    
<li>
    <a href="../09/" class="dropdown-item">Micrometer 监控</a>
</li>
                                    
<li>
    <a href="../10/" class="dropdown-item">Spring Gateway 网关</a>
</li>
                                    
<li>
    <a href="../11/" class="dropdown-item">Seata 分布式事务</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Spring 进阶内容 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../12/" class="dropdown-item">Reactor 框架</a>
</li>
                                    
<li>
    <a href="../13/" class="dropdown-item">Spring WebFlux</a>
</li>
                                    
<li>
    <a href="../14/" class="dropdown-item">Spring Security</a>
</li>
                                    
<li>
    <a href="../15/" class="dropdown-item">Spring Security OAuth2 认证以及 KeyCloak 用户服务</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">其它中间件 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../16/" class="dropdown-item">Rabbit MQ 消息队列</a>
</li>
                                    
<li>
    <a href="../17/" class="dropdown-item">GraphQL</a>
</li>
                                    
<li>
    <a href="../18/" class="dropdown-item">gRPC</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">k8s 微服务技术 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../19/" class="dropdown-item">后端框架一览</a>
</li>
                                    
<li>
    <a href="../20/" class="dropdown-item">k8s 无状态服务基本部署</a>
</li>
                                    
<li>
    <a href="../21/" class="dropdown-item">helm 打包 istio 网关与 k8s 命令行工具</a>
</li>
                                    
<li>
    <a href="../22/" class="dropdown-item">k8s 无状态服务</a>
</li>
                                    
<li>
    <a href="../23/" class="dropdown-item">k8s 有状态服务</a>
</li>
                                    
<li>
    <a href="../24/" class="dropdown-item">服务网格</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown active">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">中间件补充 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../25/" class="dropdown-item">Nacos 服务治理</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active">Sentinel</a>
</li>
                                    
<li>
    <a href="../27/" class="dropdown-item">kafka 高性能消息队列</a>
</li>
                                    
<li>
    <a href="../28/" class="dropdown-item">Redis</a>
</li>
                                    
<li>
    <a href="../29/" class="dropdown-item">OTel-LGTM</a>
</li>
                                    
<li>
    <a href="../30/" class="dropdown-item">Dubbo RPC</a>
</li>
                                    
<li>
    <a href="../31.md" class="dropdown-item">Nginx</a>
</li>
                                    
<li>
    <a href="../32.md" class="dropdown-item">Treafik</a>
</li>
                                    
<li>
    <a href="../33.md" class="dropdown-item">Citus</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../25/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../27/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#ch26-sentinel" class="nav-link">中间件速成 Ch26 Sentinel</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#sentinel" class="nav-link">Sentinel 的保护策略</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sentinel_1" class="nav-link">Sentinel 使用</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sentinel-fallback" class="nav-link">Sentinel Fallback 机制</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sentinel_2" class="nav-link">Sentinel 流量控制</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sentinel_3" class="nav-link">Sentinel 熔断降级</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#sentinel_4" class="nav-link">Sentinel 热点参数限流</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="ch26-sentinel">中间件速成 Ch26 Sentinel</h1>
<p>Sentinel 是阿里巴巴开源的一款流量控制、熔断降级的 Java 中间件，它提供了一套完整的流量控制方案，包括流量控制、熔断降级、系统负载保护等功能。Sentinel 通过实时的监控系统的运行状态，对系统的流量进行实时的监控，当系统的流量超过了预设的阈值时，Sentinel 会对流量进行控制，保护系统的稳定运行。</p>
<p>相比 Resilience4j，Sentinel 提供了更多的流量控制策略，包括流量控制、熔断降级、系统负载保护等功能。Sentinel 通过实时的监控系统的运行状态，对系统的流量进行实时的监控，当系统的流量超过了预设的阈值时，Sentinel 会对流量进行控制，保护系统的稳定运行。</p>
<h2 id="sentinel">Sentinel 的保护策略</h2>
<p>Sentiel 保护策略如下。对于用户可以访问的每个资源，可以提供若干规则，例如流量控制，服务降级等。如果违反规则，则会抛出异常，进行 Fallback。否则直接放行。</p>
<p>可以看出，Sentinel 保护有三个关键点：定义资源，定义规则，Fallback 逻辑。</p>
<h2 id="sentinel_1">Sentinel 使用</h2>
<p>首先启动 Sentinel 的 Dashboard，这里需要在<a href="https://github.com/alibaba/Sentinel/releases">这里</a>获取 jar 包，直接启动即可。默认账号与密码都是 Sentinel。</p>
<p>然后引入 Sentinel。此外为了演示，我们还引入 OpenFeign。Sentinel 有 OpenFeign 的集成，可以直接使用。</p>
<pre><code class="language-groovy">implementation 'org.springframework.cloud:spring-cloud-starter-openfeign:4.2.0'
implementation 'com.alibaba.cloud:spring-cloud-starter-alibaba-sentinel:2023.0.3.2'
implementation 'org.springframework.cloud:spring-cloud-starter-loadbalancer:4.2.0'
</code></pre>
<p>现在我们再创建一个微服务，让新的微服务调用之前的微服务。这里我们使用 OpenFeign 来调用。</p>
<pre><code class="language-java">package com.github.fingerbone;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;

@FeignClient(value = &quot;app&quot;)
public interface TestClient {
    @GetMapping(&quot;/hello&quot;)
    public String hello();
}
</code></pre>
<pre><code class="language-java">package com.github.fingerbone;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.bind.annotation.GetMapping;

@RestController
public class TestController {
   @Autowired
   private TestClient testClient;

   @GetMapping(&quot;/delegate&quot;)
   public String delegateHello() {
       return testClient.hello();
   }

}
</code></pre>
<p>现在直接启动即可。注意，Sentinel 是懒加载的，所以需要访问一次才能在 Dashboard 上看到。当然，也可以在配置文件中开启 eager 模式。此外还要配置 <code>spring.cloud.sentinel.transport.dashboard</code> 来指定 Dashboard 的地址。</p>
<pre><code class="language-yaml">spring:
  cloud:
    sentinel:
      transport:
        dashboard: localhost:8080
      eager: true
</code></pre>
<p>此外，还要开启 Sentinel 的 Feign 整合。</p>
<pre><code class="language-yaml">feign:
  sentinel:
    enabled: true
</code></pre>
<p>发送几个请求，然后就可以在 Dashboard 上看到了。</p>
<p>默认情况下，Sentinel 会把每一个 Web Endpoint 作为一个资源。如果开启了 Feign 整合，那么 Feign 的调用。</p>
<p>此外，还可以通过向方法上添加 <code>@SentinelResource</code> 注解来定义资源。注意，每一个有 <code>@SentinelResource</code> 注解的方法都会被 Sentinel 保护。</p>
<pre><code class="language-java">@SentinelResource(value = &quot;hello&quot;)
</code></pre>
<p>然后就可以直接在 Dashboard 上看到定义的资源。</p>
<p><img alt="Sentinel Dashboard" src="image.png" /></p>
<p>不过注意，<code>@SentinelResouce</code> 注解应该加在非 Web Endpoint 的方法上，例如 Service 层的方法。</p>
<p>如果一个资源获取了另一个资源，在 Dashboard 上会有调用链的显示。</p>
<h2 id="sentinel-fallback">Sentinel Fallback 机制</h2>
<p>Sentinel 在触发时，会抛出 <code>BlockException</code> 异常。有四种情况来处理这个异常。</p>
<h3 id="web">Web 接口错误处理</h3>
<p>Sentinel 会调用 <code>BlockExceptionHandler</code> 来处理异常。可以通过实现 <code>BlockExceptionHandler</code> 接口来自定义异常处理。</p>
<pre><code class="language-java">public class CustomBlockExceptionHandler implements BlockExceptionHandler {
    @Override
    public void handle(
        HttpServletRequest request,
         HttpServletResponse response, 
         String resouceName,
         BlockException e) throws Exception {
        response.setStatus(429);
        response.getWriter().write(&quot;Too many requests&quot;);
    }
}
</code></pre>
<h3 id="sentinelresource-fallback">@SentinelResource Fallback</h3>
<p>对于 SentinelResouce 的 Fallback，可以通过 <code>fallback</code> 属性来指定 Fallback 方法。注意，还有一个参数 <code>blockHandler</code>，它的功能与 <code>fallback</code> 类似，但是它更优先。</p>
<pre><code class="language-java">@SentinelResource(value = &quot;hello&quot;, fallback = &quot;fallback&quot;, blockHandler = &quot;blockHandler&quot;)
public String hello() {
    return &quot;Hello&quot;;
}

public String fallback(Throwable e) {
    return &quot;Fallback&quot;;
}

public String blockHandler(BlockException e) {
    return &quot;BlockHandler&quot;;
}
</code></pre>
<p>Fallback 或 BlockHandler 的函数参数比原本的函数多一个参数，即对应的 Exception。</p>
<p>当一个异常被抛出，如果是 BlockException，即 Sentinel 触发，那么会调用 BlockHandler，如果没有 BlockHandler，那么会调用 Fallback。如果没有 Fallback，那么会直接抛出异常到 Spring 全局异常处理器。</p>
<p>如果是其它类型的异常，会直接走 Fallback。</p>
<h3 id="openfeign-fallback">OpenFeign Fallback</h3>
<p>OpenFeign Fallback 走的是 OpenFeign 的 Fallback 返回，例如，</p>
<pre><code class="language-java">package com.github.fingerbone;

import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.GetMapping;
@FeignClient(value = &quot;app&quot;, fallback = TestClientFallback.class)
public interface TestClient {
    @GetMapping(&quot;/hello&quot;)
    public String hello();
}
</code></pre>
<pre><code class="language-java">package com.github.fingerbone;

import org.springframework.stereotype.Component;

@Component
public class TestClientFallback implements TestClient {
    @Override
    public String hello() {
        return &quot;Fallback&quot;;
    }
}
</code></pre>
<h3 id="sphu-try-catch">SphU try-catch</h3>
<p>最后一种方法是使用 <code>SphU</code> 的 <code>try-catch</code> 方法来处理异常。事实上，Sentinel 代理了原本的方法，每次调用时，都会使用 <code>SphU</code> 的 <code>try-catch</code> 方法来处理异常。</p>
<p>即对于一个受保护的函数 <code>func()</code>，实际执行过程如下，</p>
<pre><code class="language-java">try {
    SphU.entry(&quot;func&quot;);
    func();
} catch (BlockException e) {
    // Fallback
}
</code></pre>
<h2 id="sentinel_2">Sentinel 流量控制</h2>
<p>下面介绍 Sentinel 三种基础保护机制的参数。</p>
<p>对于流量控制，有，</p>
<p><img alt="流量控制高级参数" src="image-1.png" /></p>
<p>流控模式中，直接模式是指不考虑任何情况，只要访问资源的来源超过了阈值，就会触发流控。</p>
<p>链路策略模式要指定一个入口。只有来自入口的流量超过了阈值，才会触发流控。</p>
<p>使用链路模式，需要将 <code>spring.cloud.sentinel.web-context-unify</code> 设置为 <code>false</code>。否则，Sentinel 不会将不同 WebEndpoint 调用的同一个 Service 分列开。</p>
<p>最后是关联策略。关联策略的使用场景是写频繁时对读限流，没有写时对读不限流。关联模式可以指定一个关联的资源，只有关联的资源超过了阈值，自己也超过了阈值，才会触发流控。</p>
<p>此外还有三种流控效果，</p>
<p>快速失败模式是指只要触发流控，直接拒绝服务。</p>
<p>Warm Up 模式有一个额外的 Period 参数。在 Period 时间内，流量逐渐增加，直到达到阈值。增加是线性的，冷状态是 <code>QPS / Period</code> 个请求，之后秒增加到 <code>QPS</code> 个请求。</p>
<p>排队等待模式是指当流量超过阈值时，不直接拒绝服务，而是排队等待。这个模式需要指定一个等待时间 timeout，如果等待时间超过了，就会拒绝服务。</p>
<h2 id="sentinel_3">Sentinel 熔断降级</h2>
<p>熔断的作用是切断不稳定的调用链，使得某个服务快速 Fallback，以避免服务雪崩。否在，单个服务的不稳定可能会被放大导致整个系统的崩溃。</p>
<p>熔断降级用于远程调用部分，这里的原理已经在 Resilience4j 部分介绍过了，关于慢调用，异常比例，异常数等。</p>
<h2 id="sentinel_4">Sentinel 热点参数限流</h2>
<p>这一功能适用于对于某个访问频繁的参数，例如大卖的某个商品 ID，对于这个商品 ID 的访问频率超过了阈值，就会触发热点参数限流。这属于流量控制的更细粒度的控制，可以控制只对某个参数进行限流。</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
