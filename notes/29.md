# 中间件速成 Ch29 OTel-LGTM

OTel-LGTM 是指的一组工具和库，主要用于在分布式系统中进行跟踪（Tracing）、日志（Logging）、度量（Metrics）等方面的 observability（可观察性）工作。它是 OpenTelemetry（OTel）的扩展和实现，目的是让开发者能够以更简单、集中的方式监控和调试他们的应用程序。

OTelemetry 负责收集数据，L 是指 Loki 日志数据库，G 指 Grafana 可视化工具，T 指 Tempo 链路数据库，M 指 Prometheus Metric 度量数据库。 这些工具通常组合在一起使用，支持实时收集数据并监控。

## 启动

直接使用 docker 镜像即可，所有工具均已打包好，官方在 github 页面也提供了 k8s 版本。

```yaml
version: '3'
services:
  grafana-otel-lgtm:
    image: grafana/otel-lgtm
    ports:
      - "3000:3000"
      - "4317:4317"
      - "4318:4318"
    stdin_open: true
    tty: true
```

要启动的内容比较多，因此启动时间有点长。

## 发送数据

这里使用 js 演示，

```bash
npm install express @opentelemetry/api @opentelemetry/sdk-trace-node @opentelemetry/sdk-metrics-base @opentelemetry/exporter-metrics-otlp-http @opentelemetry/exporter-trace-otlp-http
```

```js
// 导入依赖
const express = require('express');
const { trace } = require('@opentelemetry/api');
const { NodeTracerProvider } = require('@opentelemetry/sdk-trace-node');
const { OTLPTraceExporter } = require('@opentelemetry/exporter-trace-otlp-http');
const { MeterProvider } = require('@opentelemetry/sdk-metrics-base');
const { OTLPMetricExporter } = require('@opentelemetry/exporter-metrics-otlp-http');

// 初始化 OpenTelemetry 跟踪提供者
const tracerProvider = new NodeTracerProvider();
const traceExporter = new OTLPTraceExporter({
  url: 'http://localhost:4317/v1/traces', // OTel-LGTM Trace 服务地址
});
tracerProvider.addSpanProcessor(new SimpleSpanProcessor(traceExporter));
tracerProvider.register();

// 初始化 OpenTelemetry 度量提供者
const meterProvider = new MeterProvider();
const meter = meterProvider.getMeter('custom-metrics', '1.0.0');
const requestCounter = meter.createCounter('http_requests_total', {
  description: 'Total HTTP Requests Received',
  unit: '1',
});

// 创建一个计数器
let requestCount = 0;

// 启动 Express 应用
const app = express();
const port = 8000;

// 更新计数器的函数
function updateRequestCounter() {
  requestCount++;
  requestCounter.add(1, { route: 'http' });
}

// 设置路由
app.get('/metrics', (req, res) => {
  // 返回自定义的 HTTP 请求计数
  res.send(`HTTP Requests: ${requestCount}`);
});

app.get('/failme', (req, res) => {
  // 模拟 500 错误
  res.status(500).send('Server Error');
});

app.get('*', (req, res) => {
  // 更新请求计数
  updateRequestCounter();

  // 获取当前请求的 Span
  const span = trace.getActiveSpan();
  if (span) {
    // 设置 span 属性
    span.setAttribute("http.route", req.url);
    span.updateName(`${req.method} ${req.url}`);
  }

  // 返回默认响应
  res.send('Hello World');
});

// 启动 HTTP 服务器
app.listen(port, () => {
  console.log(`HTTP server started on http://localhost:${port}`);
});
```
